<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rewardflow.infra.mysql.mapper.PlayDurationReportMapper">

  <resultMap id="PlayDurationReportMap" type="com.rewardflow.infra.mysql.entity.PlayDurationReportDO">
    <id column="id" property="id"/>
    <result column="user_id" property="userId"/>
    <result column="sound_id" property="soundId"/>
    <result column="biz_scene" property="bizScene"/>
    <result column="duration" property="duration"/>
    <result column="sync_time" property="syncTime"/>
    <result column="biz_date" property="bizDate"/>
    <result column="create_time" property="createTime"/>
    <result column="update_time" property="updateTime"/>
  </resultMap>

  <insert id="insert" parameterType="com.rewardflow.infra.mysql.entity.PlayDurationReportDO" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO play_duration_report
      (user_id, sound_id, biz_scene, duration, sync_time, biz_date)
    VALUES
      (#{userId}, #{soundId}, #{bizScene}, #{duration}, #{syncTime}, #{bizDate})
  </insert>

  <resultMap id="PlayReportAggResultMap" type="com.rewardflow.infra.mysql.entity.PlayReportAggResult">
    <result column="delta_duration" property="deltaDuration"/>
    <result column="max_sync_time" property="maxSyncTime"/>
  </resultMap>

  <select id="selectAggSince" resultMap="PlayReportAggResultMap">
    SELECT
      COALESCE(SUM(duration), 0) AS delta_duration,
      MAX(sync_time) AS max_sync_time
    FROM play_duration_report
    WHERE user_id = #{userId}
      AND biz_scene = #{bizScene}
      AND biz_date = #{bizDate}
      AND sync_time &gt; #{lastSyncTime}
  </select>

</mapper>
