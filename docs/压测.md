#  压测与可观测性

## 启动

```bash
# 1) 启动依赖（MySQL/Redis/RabbitMQ/Nacos/Jaeger/Prometheus/Grafana）
docker compose up -d

# 2) 启动应用（示例）
cd rewardflow-app
mvn -DskipTests spring-boot:run
```

## 指标

- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin)
  - Dashboard: "RewardFlow - Overview" / "RewardFlow - Outbox"
- Jaeger: http://localhost:16686

### 关键自定义指标（Prometheus 名称）

- `rewardflow_outbox_pending`：当前待投递 outbox 数量（gauge）
- `rewardflow_outbox_failed`：当前失败 outbox 数量（gauge，status=2）
- `rewardflow_outbox_publish_total{event_type,result}`：outbox 投递结果计数（counter）
- `rewardflow_outbox_publish_latency_seconds{event_type,result}`：outbox 投递耗时（histogram/timer）

## 告警

Prometheus 会加载 `deploy/observability/alert_rules.yml`，示例告警包括：

- Outbox backlog 超阈值（`rewardflow_outbox_pending`）
- Outbox 出现失败事件（`rewardflow_outbox_failed > 0`）
- Outbox 发布失败率过高（基于 `rewardflow_outbox_publish_total` 计算 fail/total）

## 压测

```bash
bash deploy/loadtest/run_k6.sh
```

可通过环境变量调整：

```bash
REWARDFLOW_BASE_URL=http://127.0.0.1:8080 REWARDFLOW_SCENE=audio_play bash deploy/loadtest/run_k6.sh
```
