# RewardFlow 业务梳理

本项目是一个“播放上报 -> 规则预览 -> 发奖落库 -> 事件投递”的闭环系统，包含 MySQL/Mongo/Redis/RabbitMQ 与配置中心。
约定：scene 统一使用下划线（服务端会把输入中的 ":" 转成 "_"）。

## 模块结构

- `rewardflow-api`：对外 API DTO 定义。
- `rewardflow-app`：核心应用，包含控制层、服务编排、风控、发奖、定时任务、配置与 metrics。
- `rewardflow-domain`：领域计算（奖励计算器、规则模型）。
- `rewardflow-infra`：MySQL/Mongo/Redis/RabbitMQ 基础设施接入与数据访问层（mapper/repo）。

## 主业务链路（播放上报）

1) 客户端调用 `POST /api/v1/play/report`
2) 服务端进行基础校验与风控（时长、时间偏差、分钟级限流）
3) 明细写入 `play_duration_report`（幂等靠唯一索引）
4) 计算当日总时长（仅当用户进入“高频”才走 Redis 累加，否则走 MySQL 增量聚合）
5) 奖励规则预览（规则中心/灰度）
6) 发奖：写入 `reward_flow` 并记录 outbox
7) outbox 定时发布到 MQ（at-least-once）

## 关键数据表

- `play_duration_report`：播放明细（幂等唯一索引：user_id + sound_id + sync_time）
- `user_play_daily`：日汇总
- `reward_flow`：发奖流水
- `reward_outbox`：发奖事件 outbox

## 关键服务

- `PlayReportAppService`：播放上报主编排
- `PlayDailyAggService`：MySQL 增量聚合
- `PlayDailyRedisAggService`：Redis 累加 + 5s flush 降频写
- `AwardPreviewService`：规则预览
- `AwardIssueService`：发奖执行（handler 路由）
- `OutboxPublishJob`：outbox 投递

## Redis 降频聚合机制（高频路由）

- 目标：避免热点 `(user_id, scene, biz_date)` 频繁更新 `user_play_daily`
- 高频判定：同 `(user_id, scene)` 60 秒内上报次数 ≥ 10 即标记高频，保持 2 分钟
- 机制：高频用户上报成功后写 Redis 累加，5s 定时 flush 到 MySQL
- 非高频：仍走 MySQL 增量聚合（避免常规用户走 Redis）
- 可靠性：
  - `pending`/`inflight` 双缓冲，flush 成功后更新 `base_total`
  - flush 失败回滚 `pending`
  - `maxSyncTime` 幂等边界避免重复累加
